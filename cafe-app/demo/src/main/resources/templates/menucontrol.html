<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Menu Cafe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body { padding: 20px; background-color: #f5f5f5; }
        .alert { position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; }
    </style>
</head>
<body class="container">
    <h2 class="mb-4">Quản lý Menu</h2>

    <div id="alertBox" class="alert" style="display: none;" role="alert"></div>

    <div class="card p-4 mb-4 shadow-sm">
        <h4 class="mb-3">Thông tin món ăn</h4>
        <form id="menuForm">
            <input type="hidden" id="id">
            <div class="row">
                <div class="col-md-6 mb-3"><label for="name" class="form-label">Tên món: <span class="text-danger">*</span></label><input type="text" class="form-control" id="name" required></div>
                <div class="col-md-6 mb-3"><label for="category" class="form-label">Danh mục: <span class="text-danger">*</span></label><select class="form-select" id="category" required><option value="">-- Chọn danh mục --</option><option value="Cafe">Cafe</option><option value="Trà Sữa">Trà Sữa</option><option value="Nước ép">Nước ép</option><option value="Trà">Trà</option><option value="Topping">Topping</option></select></div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3"><label for="priceS" class="form-label">Giá Size S (VNĐ):</label><input type="number" class="form-control" id="priceS" min="0" step="1000" placeholder="Để trống nếu không có"></div>
                <div class="col-md-4 mb-3"><label for="price" class="form-label">Giá Size M (VNĐ): <span class="text-danger">*</span></label><input type="number" class="form-control" id="price" min="0" step="1000" required></div>
                <div class="col-md-4 mb-3"><label for="priceL" class="form-label">Giá Size L (VNĐ):</label><input type="number" class="form-control" id="priceL" min="0" step="1000" placeholder="Để trống nếu không có"></div>
            </div>
            <div class="mb-3"><label for="description" class="form-label">Mô tả:</label><textarea class="form-control" id="description" rows="2" placeholder="Mô tả ngắn gọn..."></textarea></div>
            <div class="mb-3"><label for="image" class="form-label">Hình ảnh (URL):</label><input type="text" class="form-control" id="image" placeholder="https://example.com/image.jpg"></div>
            <div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="available" checked><label class="form-check-label" for="available">Có sẵn để bán</label></div>
            <div class="d-flex gap-2"><button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Lưu</button><button type="button" class="btn btn-secondary" onclick="resetForm()"><i class="bi bi-arrow-clockwise"></i> Làm mới</button></div>
        </form>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white"><h4 class="mb-0">Danh sách món</h4></div>
        <div class="card-body">
            <div class="table-responsive"><table class="table table-hover table-bordered"><thead class="table-light"><tr><th style="width: 5%;">ID</th><th style="width: 20%;">Tên món</th><th style="width: 15%;">Danh mục</th><th style="width: 25%;">Giá (S / M / L)</th><th style="width: 10%;">Trạng thái</th><th style="width: 25%;">Hành động</th></tr></thead><tbody id="menuTableBody"><tr><td colspan="6" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Đang tải...</span></div></td></tr></tbody></table></div>
        </div>
    </div>

    <script>
        const apiUrl = '/api/admin/menu';
        let menuItemsCache = [];

        function showAlert(message, type = 'success') {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = `alert alert-${type}`;
            alertBox.innerHTML = message;
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 3000);
        }

        function formatCurrency(amount) {
            if (amount === null || amount === undefined) {
                return 'N/A';
            }
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function resetForm() {
            document.getElementById('id').value = '';
            document.getElementById('name').value = '';
            document.getElementById('category').value = '';
            document.getElementById('priceS').value = '';
            document.getElementById('price').value = '';
            document.getElementById('priceL').value = '';
            document.getElementById('description').value = '';
            document.getElementById('image').value = '';
            document.getElementById('available').checked = true;
        }

        async function loadMenu() {
            const tableBody = document.getElementById("menuTableBody");
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Lỗi HTTP: ${response.status}`);
                const menuItems = await response.json();
                menuItemsCache = menuItems;
                tableBody.innerHTML = "";
                if (menuItems.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Chưa có món nào.</td></tr>`;
                    return;
                }
                menuItems.forEach(item => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td><strong>${escapeHtml(item.name)}</strong></td>
                        <td><span class="badge bg-info">${escapeHtml(item.category)}</span></td>
                        <td>${formatCurrency(item.priceS)} / <strong class="text-primary">${formatCurrency(item.price)}</strong> / ${formatCurrency(item.priceL)}</td>
                        <td>${item.available ? '<span class="badge bg-success">Có sẵn</span>' : '<span class="badge bg-danger">Hết hàng</span>'}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editItemById(${item.id})"><i class="bi bi-pencil"></i> Sửa</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id})"><i class="bi bi-trash"></i> Xóa</button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Lỗi tải menu:', error);
                showAlert('Không thể tải danh sách menu: ' + error.message, 'danger');
            }
        }

        function editItemById(id) {
            const item = menuItemsCache.find(i => i.id === id);
            if (!item) { showAlert('Không tìm thấy món!', 'danger'); return; }
            document.getElementById('id').value = item.id || '';
            document.getElementById('name').value = item.name || '';
            document.getElementById('category').value = item.category || '';
            document.getElementById('priceS').value = item.priceS || '';
            document.getElementById('price').value = item.price || '';
            document.getElementById('priceL').value = item.priceL || '';
            document.getElementById('description').value = item.description || '';
            document.getElementById('image').value = item.image || '';
            document.getElementById('available').checked = item.available !== false;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const id = document.getElementById('id').value;
            const menuItemData = {
                name: document.getElementById('name').value.trim(),
                category: document.getElementById('category').value,
                priceS: document.getElementById('priceS').value ? parseFloat(document.getElementById('priceS').value) : null,
                price: parseFloat(document.getElementById('price').value),
                priceL: document.getElementById('priceL').value ? parseFloat(document.getElementById('priceL').value) : null,
                description: document.getElementById('description').value.trim(),
                image: document.getElementById('image').value.trim(),
                available: document.getElementById('available').checked
            };
            if (!menuItemData.name || !menuItemData.category || !menuItemData.price || menuItemData.price <= 0) {
                showAlert('Vui lòng điền đầy đủ các trường bắt buộc (*).', 'warning');
                return;
            }
            const url = id ? `${apiUrl}/${id}` : apiUrl;
            const method = id ? 'PUT' : 'POST';
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(menuItemData)
                });
                if (!response.ok) { const errorText = await response.text(); throw new Error(`${response.status} - ${errorText}`); }
                const savedItem = await response.json();
                showAlert(id ? `Đã cập nhật "${savedItem.name}"!` : `Đã thêm "${savedItem.name}"!`, 'success');
                resetForm();
                await loadMenu();
            } catch (error) {
                console.error('Lỗi lưu món:', error);
                showAlert('Lỗi khi lưu món: ' + error.message, 'danger');
            }
        }
        
        async function deleteItem(id) {
            if (!confirm('Bạn có chắc chắn muốn xóa món này?')) return;
            try {
                const response = await fetch(`${apiUrl}/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    showAlert('Đã xóa món thành công!', 'success');
                    await loadMenu();
                } else {
                    const errorText = await response.text();
                    throw new Error(`Lỗi HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('Lỗi xóa món:', error);
                showAlert('Lỗi khi xóa món: ' + error.message, 'danger');
            }
        }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('menuForm').addEventListener('submit', handleSubmit);
            loadMenu();
        });
    </script>
</body>
</html>