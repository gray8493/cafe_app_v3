<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý khách hàng</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1, h2 { color: #0056b3; }
        .container { max-width: 960px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        form label { display: block; margin-bottom: 5px; font-weight: bold; }
        form input[type="text"], form input[type="email"], form input[type="tel"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        form button { background-color: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        form button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #5a6268; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #c82333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table th, table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        table th { background-color: #007bff; color: white; }
        table tr:nth-child(even) { background-color: #f9f9f9; }
        .actions { white-space: nowrap; }
        .actions button { padding: 5px 10px; font-size: 14px; margin-right: 5px; }
        .alert { padding: 10px 15px; margin-bottom: 15px; border-radius: 4px; display: none; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Quản lý khách hàng</h1>

        <div id="alert" class="alert"></div>

        <h2>Thông tin khách hàng</h2>
        <form id="customerForm">
            <input type="hidden" id="id">
            <div class="form-group">
                <label for="name">Họ và tên:</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="phone">Số điện thoại:</label>
                <input type="tel" id="phone" pattern="[0-9]{10,11}" required>
            </div>
            <div class="form-group">
                <label for="address">Địa chỉ:</label>
                <input type="text" id="address">
            </div>
            <button type="submit">Lưu</button>
            <button type="button" onclick="resetForm()" class="secondary">Làm mới</button>
        </form>

        <h2>Danh sách khách hàng</h2>

        <!-- Thanh tìm kiếm -->
        <div class="form-group" style="margin-bottom: 20px;">
            <input type="text" id="searchInput" placeholder="Tìm kiếm theo tên, email hoặc số điện thoại..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
        </div>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Họ tên</th>
                    <th>Email</th>
                    <th>Số điện thoại</th>
                    <th>Địa chỉ</th>
                    <th>Điểm thưởng</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="customerTable">
                <!-- Dữ liệu sẽ được thêm vào đây bằng JavaScript -->
            </tbody>
        </table>
    </div>

    <script th:inline="javascript">
        const apiUrl = '/api/admin/customers';
        
        // --- HÀM TIỆN ÍCH ---
        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('alert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            setTimeout(() => { alertDiv.style.display = 'none'; }, 5000);
        }

        function escapeHtml(unsafe) {
            return (unsafe || '')
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        // --- LOGIC CRUD ---
        async function loadCustomers(searchKeyword = '') {
            try {
                const url = searchKeyword ? `${apiUrl}?search=${encodeURIComponent(searchKeyword)}` : apiUrl;
                const response = await fetch(url);
                if (!response.ok) {
                    const textError = await response.text();
                    throw new Error(`Lỗi HTTP: ${response.status} - ${textError}`);
                }

                const customers = await response.json();
                const table = document.getElementById('customerTable');
                table.innerHTML = '';

                customers.forEach(customer => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${customer.id}</td>
                        <td>${escapeHtml(customer.name)}</td>
                        <td>${escapeHtml(customer.email)}</td>
                        <td>${escapeHtml(customer.phone)}</td>
                        <td>${escapeHtml(customer.address || '')}</td>
                        <td><span class="badge bg-warning text-dark">${customer.points || 0} điểm</span></td>
                        <td class="actions">
                            <button onclick="editCustomer(${customer.id}, '${escapeHtml(customer.name)}', '${escapeHtml(customer.email)}', '${escapeHtml(customer.phone)}', '${escapeHtml(customer.address || '')}')" class="secondary">Sửa</button>
                            <button onclick="deleteCustomer(${customer.id})" class="danger">Xóa</button>
                        </td>
                    `;
                    table.appendChild(row);
                });

            } catch (error) {
                console.error('Lỗi khi tải danh sách khách hàng:', error);
                showAlert('Có lỗi xảy ra khi tải danh sách khách hàng: ' + error.message, 'error');
            }
        }
        
        async function saveCustomer(event) {
            event.preventDefault();
            
            const customer = {
                id: document.getElementById('id').value || null,
                name: document.getElementById('name').value.trim(),
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                address: document.getElementById('address').value.trim()
            };
            
            try {
                const method = customer.id ? 'PUT' : 'POST';
                const url = customer.id ? `${apiUrl}/${customer.id}` : apiUrl;
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                        // KHÔNG CẦN HEADER CSRF VÌ ĐÃ TẮT
                    },
                    body: JSON.stringify(customer)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `Lỗi HTTP: ${response.status}`);
                }
                
                resetForm();
                loadCustomers();
                showAlert(customer.id ? 'Cập nhật thông tin thành công' : 'Thêm khách hàng thành công');
                
            } catch (error) {
                console.error('Lỗi khi lưu khách hàng:', error);
                showAlert(error.message, 'error');
            }
        }
        
        async function deleteCustomer(id) {
            if (!confirm('Bạn có chắc chắn muốn xóa khách hàng này?')) {
                return;
            }
            
            try {
                const response = await fetch(`${apiUrl}/${id}`, {
                    method: 'DELETE'
                    // KHÔNG CẦN HEADER CSRF VÌ ĐÃ TẮT
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `Không thể xóa khách hàng: ${response.status}`);
                }
                
                loadCustomers();
                showAlert('Đã xóa khách hàng thành công');
                
            } catch (error) {
                console.error('Lỗi khi xóa khách hàng:', error);
                showAlert(error.message, 'error');
            }
        }
        
        function editCustomer(id, name, email, phone, address) {
            document.getElementById('id').value = id;
            document.getElementById('name').value = name;
            document.getElementById('email').value = email;
            document.getElementById('phone').value = phone;
            document.getElementById('address').value = address || '';
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Cuộn lên đầu trang
        }
        
        function resetForm() {
            document.getElementById('customerForm').reset();
            document.getElementById('id').value = '';
        }

        // --- KHỞI TẠO ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('customerForm').addEventListener('submit', saveCustomer);
            loadCustomers();

            // Thêm event listener cho thanh tìm kiếm
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;

            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    loadCustomers(e.target.value.trim());
                }, 300); // Đợi 300ms sau khi người dùng ngừng gõ
            });
        });
    </script>
</body>
</html>